<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coding.core.mapper.postgresql.KnowledgeVectorMapper">

    <!-- 插入向量，需要将embedding字符串转换为vector类型 -->
    <insert id="insert" parameterType="com.coding.core.model.entity.KnowledgeVectorDO">
        INSERT INTO knowledge_vector (
            id, 
            knowledge_base_id, 
            content, 
            metadata, 
            embedding, 
            file_name, 
            file_type, 
            create_time, 
            update_time, 
            deleted
        ) VALUES (
            #{id}, 
            #{knowledgeBaseId}, 
            #{content}, 
            #{metadata}, 
            #{embedding}::vector,
            #{fileName}, 
            #{fileType}, 
            #{createTime}, 
            #{updateTime}, 
            #{deleted}
        )
    </insert>

    <!-- 更新向量，包含embedding字段的转换 -->
    <update id="updateById" parameterType="com.coding.core.model.entity.KnowledgeVectorDO">
        UPDATE knowledge_vector
        SET
            <if test="content != null">content = #{content},</if>
            <if test="metadata != null">metadata = #{metadata},</if>
            <if test="embedding != null">embedding = #{embedding}::vector,</if>
            <if test="fileName != null">file_name = #{fileName},</if>
            <if test="fileType != null">file_type = #{fileType},</if>
            update_time = #{updateTime}
        WHERE id = #{id}
    </update>

    <select id="countByKnowledgeBaseId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM knowledge_vector
        WHERE knowledge_base_id = #{knowledgeBaseId}
          AND deleted = 0
    </select>

    <select id="similaritySearch" resultType="com.coding.core.model.entity.KnowledgeVectorDO">
        SELECT
            id,
            knowledge_base_id,
            content,
            metadata,
            file_name,
            file_type,
            create_time,
            update_time,
            1 - (embedding &lt;=&gt; #{embedding}::vector) as similarity
        FROM knowledge_vector
        WHERE knowledge_base_id = #{knowledgeBaseId}
          AND deleted = 0
          AND embedding IS NOT NULL
        ORDER BY embedding &lt;=&gt; #{embedding}::vector
        LIMIT #{topK}
    </select>

</mapper>

